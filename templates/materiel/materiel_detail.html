{% extends 'base.html' %}

{% block title %}{{ materiel.matricule }} - Détails{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">
        <i class="fas fa-box me-2"></i>Détails du matériel
    </h1>
    <div>
        <a href="{% url 'materiel_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
        {% if is_staff %}
        <a href="{% url 'materiel_update' materiel.pk %}" class="btn btn-warning ms-2">
            <i class="fas fa-edit me-2"></i>Modifier
        </a>
        <a href="{% url 'materiel_delete' materiel.pk %}" class="btn btn-danger ms-2">
            <i class="fas fa-trash me-2"></i>Supprimer
        </a>
        {% endif %}
        {% if materiel.type_materiel == 'vehicule' and is_staff %}
        <a href="{% url 'visite_create' %}?materiel={{ materiel.pk }}" class="btn btn-success ms-2">
            <i class="fas fa-wrench me-2"></i>Ajouter une visite
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Informations principales -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Informations générales
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Matricule</label>
                        <p class="form-control-plaintext fw-bold">{{ materiel.matricule }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Marque</label>
                        <p class="form-control-plaintext">{{ materiel.marque }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Type de matériel</label>
                        <p><span class="badge bg-info">{{ materiel.get_type_materiel_display }}</span></p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Type d'affectation</label>
                        <p><span class="badge bg-secondary">{{ materiel.get_type_affectation_display }}</span></p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">État</label>
                        <p>
                            {% if materiel.etat == 'neuf' %}
                                <span class="badge bg-success">{{ materiel.get_etat_display }}</span>
                            {% elif materiel.etat == 'bon' %}
                                <span class="badge bg-primary">{{ materiel.get_etat_display }}</span>
                            {% elif materiel.etat == 'usage' %}
                                <span class="badge bg-warning text-dark">{{ materiel.get_etat_display }}</span>
                            {% elif materiel.etat == 'panne' %}
                                <span class="badge bg-danger">{{ materiel.get_etat_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ materiel.get_etat_display }}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Quantité en stock</label>
                        <p class="form-control-plaintext">
                            {% if materiel.stock > 0 %}
                                <span class="text-success fw-bold">{{ materiel.stock }}</span>
                            {% else %}
                                <span class="text-danger fw-bold">0 (Rupture)</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Emplacement</label>
                        <p class="form-control-plaintext">{{ materiel.emplacement|default:"Non spécifié" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Fournisseur</label>
                        <p class="form-control-plaintext">{{ materiel.fournisseur }}</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label text-muted">Observations générales</label>
                    <div class="alert alert-light">
                        {% if materiel.observation %}
                            {{ materiel.get_observation_display }}{% if materiel.observation != 'marche' %} - {{ materiel.observation }}{% endif %}
                        {% else %}
                            <span class="text-muted">Non spécifié</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations d'affectation -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Informations d'affectation
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Service affecté</label>
                        <p class="form-control-plaintext">
                            {% if materiel.service_affecte %}
                                <i class="fas fa-building me-1"></i>{{ materiel.service_affecte }}
                            {% else %}
                                <span class="text-muted">Non affecté</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Utilisateur affecté</label>
                        <p class="form-control-plaintext">
                            {% if materiel.utilisateur_affecte %}
                                <i class="fas fa-user me-1"></i>{{ materiel.utilisateur_affecte }}
                            {% else %}
                                <span class="text-muted">Non affecté</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations véhicule (uniquement pour les véhicules) -->
        {% if materiel.type_materiel == 'vehicule' %}
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-car me-2"></i>Informations véhicule
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Type de véhicule</label>
                        <p class="form-control-plaintext">
                            {% if materiel.type_vehicule %}
                                <span class="badge bg-info">{{ materiel.get_type_vehicule_display }}</span>
                            {% else %}
                                <span class="text-muted">Non spécifié</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Numéro de châssis</label>
                        <p class="form-control-plaintext">{{ materiel.numero_vehicule|default:"Non spécifié" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Date de mise en circulation</label>
                        <p class="form-control-plaintext">
                            <i class="fas fa-car me-1"></i>{{ materiel.date_mise_circulation|date:"d/m/Y"|default:"-" }}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Type de carburant</label>
                        <p class="form-control-plaintext">
                            {% if materiel.type_carburant %}
                                <span class="badge bg-success">{{ materiel.get_type_carburant_display }}</span>
                            {% else %}
                                <span class="text-muted">Non spécifié</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Statut du véhicule</label>
                        <p class="form-control-plaintext">
                            {% if materiel.statut_vehicule %}
                                <span class="badge bg-secondary">{{ materiel.get_statut_vehicule_display }}</span>
                            {% else %}
                                <span class="text-muted">Non spécifié</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Kilométrage</label>
                        <p class="form-control-plaintext">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            {% if materiel.kilometrage %}{{ materiel.kilometrage }} km{% else %}-{% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Maintenance et Réparation -->
        <div class="card mt-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-wrench me-2"></i>Maintenance et Réparation
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Défaut/Panne</label>
                        <p class="form-control-plaintext">
                            {% if materiel.defaut_panne %}
                                <span class="badge bg-warning text-dark">{{ materiel.get_defaut_panne_display }}</span>
                            {% else %}
                                <span class="text-muted">Aucun défaut signalé</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Référence pièce</label>
                        <p class="form-control-plaintext">{{ materiel.reference_piece|default:"Non spécifié" }}</p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label text-muted">Réparation</label>
                        <div class="alert alert-light">
                            {{ materiel.reparation|default:"Aucune réparation enregistrée"|linebreaks }}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Prix</label>
                        <p class="form-control-plaintext">
                            <i class="fas fa-euro-sign me-1"></i>
                            {% if materiel.prix %}{{ materiel.prix }} €{% else %}-{% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Date de prochaine visite</label>
                        <p class="form-control-plaintext">
                            <i class="fas fa-calendar-check me-1"></i>{{ materiel.date_prochaine_visite|date:"d/m/Y"|default:"-" }}
                        </p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label text-muted">Divers</label>
                        <div class="alert alert-light">
                            {{ materiel.divers|default:"Aucune information diverses"|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations temporelles -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>Informations temporelles
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Date d'entrée</label>
                    <p class="form-control-plaintext">
                        <i class="fas fa-calendar-plus me-1"></i>{{ materiel.date_entree|date:"d/m/Y"|default:"-" }}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Date de sortie</label>
                    <p class="form-control-plaintext">
                        <i class="fas fa-truck me-1"></i>{{ materiel.date_sortie|date:"d/m/Y"|default:"-" }}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Date de création</label>
                    <p class="form-control-plaintext">
                        <i class="fas fa-clock me-1"></i>{{ materiel.created_at|date:"d/m/Y H:i" }}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Dernière mise à jour</label>
                    <p class="form-control-plaintext">
                        <i class="fas fa-edit me-1"></i>{{ materiel.updated_at|date:"d/m/Y H:i" }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions rapides -->
        {% if is_staff %}
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Actions rapides
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'materiel_update' materiel.pk %}" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>Modifier le matériel
                    </a>
                    <a href="{% url 'materiel_delete' materiel.pk %}" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Supprimer le matériel
                    </a>
                    <a href="/admin/materiel/materiel/{{ materiel.pk }}/change/" target="_blank" class="btn btn-secondary">
                        <i class="fas fa-cog me-2"></i>Admin Django
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Historique des visites (uniquement pour les véhicules) -->
{% if materiel.type_materiel == 'vehicule' %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>Historique des visites
        </h5>
        {% if is_staff %}
        <a href="{% url 'visite_create' %}?materiel={{ materiel.pk }}" class="btn btn-success btn-sm">
            <i class="fas fa-plus me-2"></i>Ajouter une visite
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if visites %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Kilométrage</th>
                            <th>Responsable</th>
                            <th>Coût</th>
                            <th>Prochaine visite</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visite in visites %}
                        <tr>
                            <td>
                                <a href="{% url 'visite_detail' visite.pk %}" class="text-decoration-none">
                                    {{ visite.date_visite }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ visite.get_type_visite_display }}</span>
                            </td>
                            <td>
                                {% if visite.kilometrage %}{{ visite.kilometrage }} km{% else %}-{% endif %}
                            </td>
                            <td>{{ visite.responsable|default:"-" }}</td>
                            <td>
                                {% if visite.cout %}{{ visite.cout }} €{% else %}-{% endif %}
                            </td>
                            <td>
                                {% if visite.prochaine_visite %}{{ visite.prochaine_visite }}{% else %}-{% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'visite_detail' visite.pk %}" class="btn btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if is_staff %}
                                    <a href="{% url 'visite_create' %}?materiel={{ materiel.pk }}" class="btn btn-outline-success" title="Ajouter une autre visite">
                                        <i class="fas fa-plus"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-wrench fa-2x text-muted mb-3"></i>
                <h6 class="text-muted">Aucune visite enregistrée pour ce véhicule</h6>
                <p class="text-muted small">
                    {% if is_staff %}
                        Commencez par ajouter une visite pour suivre l'entretien de ce véhicule.
                    {% else %}
                        Ce véhicule n'a pas encore d'historique de visites.
                    {% endif %}
                </p>
                {% if is_staff %}
                <a href="{% url 'visite_create' %}?materiel={{ materiel.pk }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Ajouter une visite
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}
